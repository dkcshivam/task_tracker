{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <h2>Task List</h2>
  <a href="{% url 'create_task' %}" class="btn btn-primary mt-2 mt-sm-0">
    <i class="bi bi-plus-circle me-1"></i> New Task
  </a>
</div>
<!-- Django messages -->
{% if messages %}
{% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endfor %}
{% endif %}
<!-- 🔍 Search Form -->
<form method="get" class="row g-2 mb-4" id="search-form">
  <div class="col-12 col-md-4 col-lg-3">
    <input type="text" name="search" class="form-control" placeholder="Search tasks..." id="search-input" value="{{ request.GET.search }}">
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <input type="text" name="task_name" class="form-control" placeholder="Search by Task Name" value="{{ request.GET.task_name }}">
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <input type="text" name="assigned_to" class="form-control" placeholder="Assigned To" value="{{ request.GET.assigned_to }}">
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <select name="status" class="form-select">
      <option value="">Status</option>
      <option value="in progress" {% if request.GET.status == 'in progress' %}selected{% endif %}>In Progress</option>
      <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
      <option value="hold" {% if request.GET.status == 'hold' %}selected{% endif %}>On Hold</option>
    </select>
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <select name="priority" class="form-select">
      <option value="">Priority</option>
      <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
      <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>Medium</option>
      <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
    </select>
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    <small class="text-muted">Start Date</small>
  </div>
  <div class="col-12 col-md-4 col-lg-2">
    <input type="date" name="expected_end_date" class="form-control" value="{{ request.GET.expected_end_date }}">
    <small class="text-muted">Expected End Date</small>
  </div>
  <div class="col-12 col-lg-auto">
    <button type="submit" class="btn btn-outline-primary w-100">Search</button>
  </div>
</form>

<!-- ✅ Highlight + disable completed task rows -->
<style>
  .completed-task {
    color: #6c757d;
    pointer-events: none;
    opacity: 0.7;
  }
  .completed-task td {
    border-color: #dee2e6;
  }
</style>

<!-- Task Table -->
<div class="table-responsive">
  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Task</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Start Date</th>
        <th>Expected End</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="task-table-body">
      {% for task in tasks %}
      <tr>
        <td>{{ task.task_name }}</td>
        <td>
          <span class="badge 
            {% if task.status == 'in progress' %} bg-info 
            {% elif task.status == 'completed' %} bg-success 
            {% elif task.status == 'hold' %} bg-warning 
            {% else %} bg-secondary {% endif %}">
            {{ task.status|upper }}
          </span>
        </td>
        <td>
          <span class="badge 
            {% if task.priority == 'low' %} bg-success 
            {% elif task.priority == 'medium' %} bg-warning 
            {% elif task.priority == 'high' %} bg-danger 
            {% else %} bg-secondary {% endif %}">
            {{ task.priority|title }}
          </span>
        </td>
        <td>{{ task.start_date|date:"d-M-Y" }}</td>
        <td>{{ task.expected_end_date|date:"d-M-Y" }}</td>
        <td>
          <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-info">Task Details</a>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Search Filter JS -->
<script>
  document.getElementById('search-input').addEventListener('keyup', function () {
    let searchTerm = this.value.toLowerCase();
    let taskRows = document.querySelectorAll('#task-table-body tr');

    taskRows.forEach(function (row) {
      let taskName = row.querySelector('td:nth-child(1)').innerText.toLowerCase();
      let assignedTo = row.querySelector('td:nth-child(2)').innerText.toLowerCase();
      let status = row.querySelector('td:nth-child(3)').innerText.toLowerCase();
      let priority = row.querySelector('td:nth-child(4)').innerText.toLowerCase();

      if (taskName.includes(searchTerm) || assignedTo.includes(searchTerm) || status.includes(searchTerm) || priority.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  
</script>
{% endblock %}
